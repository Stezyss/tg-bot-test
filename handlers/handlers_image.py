"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–∏–∞–ª–æ–≥ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏.
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–ª—å (—Ä–µ–∞–ª–∏–∑–º, –º—É–ª—å—Ç—è—à–Ω—ã–π, –∞–∫–≤–∞—Ä–µ–ª—å, –∫–∏–±–µ—Ä–ø–∞–Ω–∫ –∏–ª–∏ —Å–≤–æ–π —Å—Ç–∏–ª—å).
3. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ ImageService.
4. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
"""

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
style_kb = ReplyKeyboardMarkup([
    ["üé® –†–µ–∞–ª–∏–∑–º", "üñºÔ∏è –ú—É–ª—å—Ç—è—à–Ω—ã–π"],
    ["üíß –ê–∫–≤–∞—Ä–µ–ª—å", "ü§ñ –ö–∏–±–µ—Ä–ø–∞–Ω–∫"],
    ["‚ú® –°–≤–æ–π —Å—Ç–∏–ª—å"],
    ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
], resize_keyboard=True)

BACK_TO_MAIN = ReplyKeyboardMarkup([["üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]], resize_keyboard=True)


class ImageHandler:
    """
    –ö–ª–∞—Å—Å-—Ö–µ–Ω–¥–ª–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å ImageService –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
    –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø–∏—Å–∞–Ω–∏–µ ‚Üí —Å—Ç–∏–ª—å ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç).
    """

    def __init__(self, image_service):
        self.isvc = image_service

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE, **kw):
        """
        –ü–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        """

        context.user_data['waiting'] = 'image_prompt'
        await update.message.reply_text(
            "üé® –û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –∫—Ä—É—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è —Ç–≤–æ–µ–≥–æ –ø–æ—Å—Ç–∞!\n\n"
            "–û–ø–∏—à–∏, —á—Ç–æ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤—å —ç—Ç–æ –≤ –¥–µ—Ç–∞–ª—è—Ö.\n"
            "‚ú® *–ü—Ä–∏–º–µ—Ä:* ¬´–°—á–∞—Å—Ç–ª–∏–≤—ã–π —â–µ–Ω–æ–∫ –≤ –ø—Ä–∏—é—Ç–µ —Å –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º–∏, —Å–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å, –º–Ω–æ–≥–æ –∏–≥—Ä—É—à–µ–∫ –≤–æ–∫—Ä—É–≥¬ª\n\n"
            "üí° *–°–æ–≤–µ—Ç:* –ß–µ–º —è—Ä—á–µ –∏ –¥–µ—Ç–∞–ª—å–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç!",
            reply_markup=BACK_TO_MAIN,
            parse_mode='Markdown',
            **kw
        )

    async def handle(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str, nco_info: dict, **kw) -> bool:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

        –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è, –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        –∏ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
        """

        w = context.user_data.get('waiting')

        # 1. –ü–û–õ–£–ß–ï–ù–ò–ï –û–ü–ò–°–ê–ù–ò–Ø
        
        if w == 'image_prompt':
            if text == "üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
                context.user_data.clear()
                from .handlers_nco import get_main_keyboard
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏!",
                    reply_markup=get_main_keyboard(True), **kw
                )
                return True

            context.user_data['image_prompt'] = text
            context.user_data['waiting'] = 'image_style'

            await update.message.reply_text(
                f"‚ú® –û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–æ–º–Ω–∏–ª —Ç–≤–æ—ë –æ–ø–∏—Å–∞–Ω–∏–µ: *{text[:50]}...*\n\n"
                "–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π –≤—ã–±–µ—Ä–µ–º —Å—Ç–∏–ª—å ‚Äî –æ—Ç —ç—Ç–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏!\n\n"
                "üéØ *–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª–µ–π:*\n"
                "‚Ä¢ ¬´üé® –†–µ–∞–ª–∏–∑–º¬ª ‚Äî –∫–∞–∫ –∂–∏–≤–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è\n"
                "‚Ä¢ ¬´üñºÔ∏è –ú—É–ª—å—Ç—è—à–Ω—ã–π¬ª ‚Äî —è—Ä–∫–æ –∏ –≤–µ—Å–µ–ª–æ\n"
                "‚Ä¢ ¬´üíß –ê–∫–≤–∞—Ä–µ–ª—å¬ª ‚Äî –Ω–µ–∂–Ω–æ –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏\n"
                "‚Ä¢ ¬´ü§ñ –ö–∏–±–µ—Ä–ø–∞–Ω–∫¬ª ‚Äî —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–Ω–æ –∏ —Å–º–µ–ª–æ",
                reply_markup=style_kb,
                parse_mode='Markdown',
                **kw
            )
            return True

        # 2. –í–´–ë–û–† –ì–û–¢–û–í–û–ì–û –°–¢–ò–õ–Ø

        if w == 'image_style':
            if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
                context.user_data['waiting'] = 'image_prompt'
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π –∏–∑–º–µ–Ω–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏.\n\n–û–ø–∏—à–∏ –∑–∞–Ω–æ–≤–æ, —á—Ç–æ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å:",
                    reply_markup=BACK_TO_MAIN,
                    parse_mode='Markdown',
                    **kw
                )
                return True

            styles = {
                "üé® –†–µ–∞–ª–∏–∑–º": "—Ä–µ–∞–ª–∏–∑–º",
                "üñºÔ∏è –ú—É–ª—å—Ç—è—à–Ω—ã–π": "–º—É–ª—å—Ç—è—à–Ω—ã–π",
                "üíß –ê–∫–≤–∞—Ä–µ–ª—å": "–∞–∫–≤–∞—Ä–µ–ª—å",
                "ü§ñ –ö–∏–±–µ—Ä–ø–∞–Ω–∫": "–∫–∏–±–µ—Ä–ø–∞–Ω–∫"
            }

            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –æ–¥–∏–Ω –∏–∑ —Å—Ç–∏–ª–µ–π
            if text in styles:
                await update.message.reply_text(
                    "üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É... –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã! ‚è≥",
                    **kw
                )

                img = await self.isvc.generate_image(
                    context.user_data['image_prompt'], nco_info, styles[text]
                )

                from .handlers_nco import get_main_keyboard
                if img:
                    await update.message.reply_photo(
                        photo=img,
                        caption="‚úÖ –ì–æ—Ç–æ–≤–æ! –ù—Ä–∞–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç?\n\n–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Å—Ç–∏–ª—å –∏–ª–∏ —É—Ç–æ—á–Ω–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!",
                        reply_markup=get_main_keyboard(True), **kw
                    )
                else:
                    await update.message.reply_text(
                        "üòï –£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?",
                        reply_markup=get_main_keyboard(True), **kw
                    )

                context.user_data.clear()
                return True

            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–≤–æ–π —Å—Ç–∏–ª—å
            if text == "‚ú® –°–≤–æ–π —Å—Ç–∏–ª—å":
                context.user_data['waiting'] = 'custom_image_style'
                await update.message.reply_text(
                    "üé® –ö—Ä—É—Ç–æ! –¢–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ ‚Äî —ç—Ç–æ –∑–¥–æ—Ä–æ–≤–æ!\n\n"
                    "–û–ø–∏—à–∏ —Å–≤–æ–π —Å—Ç–∏–ª—å —Å–ª–æ–≤–∞–º–∏ ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –µ–≥–æ –≤–æ—Å—Å–æ–∑–¥–∞—Ç—å.\n\n"
                    "‚ú® *–ü—Ä–∏–º–µ—Ä—ã:*\n"
                    "‚Ä¢ ¬´–í —Å—Ç–∏–ª–µ –ø–æ–ø-–∞—Ä—Ç –∫–∞–∫ —É –≠–Ω–¥–∏ –£–æ—Ä—Ö–æ–ª–∞¬ª\n"
                    "‚Ä¢ ¬´–†–µ—Ç—Ä–æ-—Ñ—É—Ç—É—Ä–∏–∑–º 80-—Ö¬ª\n"
                    "‚Ä¢ ¬´–ö–∞–∫ –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π —Å–∫–µ—Ç—á —Å –ª—ë–≥–∫–æ–π –Ω–µ–±—Ä–µ–∂–Ω–æ—Å—Ç—å—é¬ª\n\n"
                    "–ö–∞–∫–æ–π —Å—Ç–∏–ª—å —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å?",
                    reply_markup=ReplyKeyboardMarkup([["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]], resize_keyboard=True),
                    parse_mode='Markdown',
                    **kw
                )
                return True

        # 3. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –°–¢–ò–õ–¨
        if w == 'custom_image_style':
            if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
                context.user_data['waiting'] = 'image_style'
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –≤—ã–±–∏—Ä–∞–π —Å—Ç–∏–ª—å –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.",
                    reply_markup=style_kb,
                    parse_mode='Markdown',
                    **kw
                )
                return True

            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å—Ç–∏–ª–µ–º
            await update.message.reply_text(
                "üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å —Ç–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å—Ç–∏–ª–µ–º... –ñ–¥–∏ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞! ‚ú®",
                **kw
            )

            img = await self.isvc.generate_image(
                context.user_data['image_prompt'], nco_info, text
            )

            from .handlers_nco import get_main_keyboard
            if img:
                await update.message.reply_photo(
                    photo=img,
                    caption="‚úÖ –í–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å —Ç–≤–æ–∏–º —Å—Ç–∏–ª–µ–º! –ù—Ä–∞–≤–∏—Ç—Å—è?\n\n–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ –∏ –æ–ø–∏—à–∏ –ø–æ-–¥—Ä—É–≥–æ–º—É!",
                    reply_markup=get_main_keyboard(True), **kw
                )
            else:
                await update.message.reply_text(
                    "üòï –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É —Å —Ç–∞–∫–∏–º —Å—Ç–∏–ª–µ–º... –ú–æ–∂–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç?",
                    reply_markup=get_main_keyboard(True), **kw
                )

            context.user_data.clear()
            return True

        return False
