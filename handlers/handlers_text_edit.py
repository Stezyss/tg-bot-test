"""
–ú–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
- —Å–º–µ–Ω–∞ —Å—Ç–∏–ª—è
- –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ
- –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ / –≤—ã—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—ç—Ç–∞–ø–Ω–æ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç.
2. –í—ã–±–∏—Ä–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ.
3. (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–ª—å.
4. –ü–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
"""

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–µ–π—Å—Ç–≤–∏–π
action_kb = ReplyKeyboardMarkup([
    ["üìà –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–µ–∫—Å—Ç", "üìâ –°–æ–∫—Ä–∞—Ç–∏ —Ç–µ–∫—Å—Ç"],
    ["‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏", "üé® –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å"],
    ["üîÑ –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å"],
    ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
], resize_keyboard=True)

style_kb = ReplyKeyboardMarkup([
    ["üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π", "üìã –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π"],
    ["üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π", "‚ö™ –ë–µ–∑ —Å—Ç–∏–ª—è"],
    ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
], resize_keyboard=True)

BACK_TO_MAIN = ReplyKeyboardMarkup([["üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]], resize_keyboard=True)


class TextEditHandler:
    """
    –ö–ª–∞—Å—Å-—Ö–µ–Ω–¥–ª–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

    –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç—Ä—ë—Ö —à–∞–≥–∞—Ö:
    1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    2. –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    3. (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è
    """

    def __init__(self, text_service):
        """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä TextService, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
        self.ts = text_service

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE, **kw):
        """
        –°—Ç–∞—Ä—Ç –¥–∏–∞–ª–æ–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.
        –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        context.user_data['waiting'] = 'edit_text'
        await update.message.reply_text(
            "‚úçÔ∏è *–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç!*\n\n"
            "–ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å.\n\n"
            "üí° *–ü—Ä–∏–º–µ—Ä:* ¬´–°–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–º–æ–≥–ª–∏ 10 –∂–∏–≤–æ—Ç–Ω—ã–º. –°–ø–∞—Å–∏–±–æ –≤—Å–µ–º –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º –∑–∞ –ø–æ–º–æ—â—å!¬ª\n\n"
            "–Ø –ø–æ–º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –ª—É—á—à–µ!",
            reply_markup=BACK_TO_MAIN,
            parse_mode='Markdown',
            **kw
        )

    async def handle(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str, nco_info: dict, **kw):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç—Ç–∞–ø–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

        –£–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏–∫–æ–π:
        - –æ–∂–∏–¥–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        - –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
        - –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è
        - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        """

        w = context.user_data.get('waiting')

        # 1. –ü–û–õ–£–ß–ï–ù–ò–ï –ò–°–•–û–î–ù–û–ì–û –¢–ï–ö–°–¢–ê
        if w == 'edit_text':
            if text == "üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
                context.user_data.clear()
                from .handlers_nco import get_main_keyboard
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏!",
                    reply_markup=get_main_keyboard(True),
                    **kw
                )
                return True

            context.user_data['edit_text'] = text
            context.user_data['waiting'] = 'edit_action'

            await update.message.reply_text(
                f"‚úÖ –¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: *{text[:50]}...*\n\n"
                "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º? –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=action_kb,
                parse_mode='Markdown',
