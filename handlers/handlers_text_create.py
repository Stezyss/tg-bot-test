"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –ø–æ—Å—Ç–æ–≤.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞:
1. –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∏–¥–µ—é —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ ‚Äî –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ.

–≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞:
- –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
- (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞
- –≤–≤–æ–¥ –¥–µ—Ç–∞–ª–µ–π
- –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è
- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ TextService
"""

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
text_mode_kb = ReplyKeyboardMarkup([
    ["üí¨ –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç", "üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞"],
    ["üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
], resize_keyboard=True)

post_type_kb = ReplyKeyboardMarkup([
    ["üì¢ –ê–Ω–æ–Ω—Å", "üì∞ –ù–æ–≤–æ—Å—Ç–∏"],
    ["üéØ –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é", "üìä –û—Ç—á–µ—Ç"],
    ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
], resize_keyboard=True)

style_kb = ReplyKeyboardMarkup([
    ["üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π", "üìã –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π"],
    ["üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π", "‚ö™ –ë–µ–∑ —Å—Ç–∏–ª—è"],
    ["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]
], resize_keyboard=True)

BACK_TO_MAIN = ReplyKeyboardMarkup([["üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]], resize_keyboard=True)
BACK_SIMPLE = ReplyKeyboardMarkup([["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]], resize_keyboard=True)


class TextCreateHandler:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

    –£–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ç—ã—Ä—å–º—è —ç—Ç–∞–ø–∞–º–∏:
    1. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
    2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞
    3. –í–≤–æ–¥ –¥–µ—Ç–∞–ª–µ–π
    4. –í—ã–±–æ—Ä —Å—Ç–∏–ª—è

    –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å –≤ TextService –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
    """

    def __init__(self, text_service):
        self.ts = text_service

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE, **kw):
        """
        –°—Ç–∞—Ä—Ç —Ä–∞–±–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ ‚Äî –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞.
        """
        context.user_data['waiting'] = 'text_mode'
        await update.message.reply_text(
            "üëã –ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –æ—Ç–ª–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å—Ç–∞!\n\n"
            "‚ú® *–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:*\n"
            "‚Ä¢ *üí¨ –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç* ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ –∏–¥–µ—é —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏\n"
            "‚Ä¢ *üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞* ‚Äî –≤—ã–±–µ—Ä–µ–º —Ç–∏–ø –ø–æ—Å—Ç–∞ –∏ –¥–µ—Ç–∞–ª–∏\n\n"
            "–ß—Ç–æ —Ç–µ–±–µ –±–æ–ª—å—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç?",
            reply_markup=text_mode_kb,
            parse_mode='Markdown',
            **kw
        )

    async def handle(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str, nco_info: dict, **kw):
        """
        –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

        –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è:
        ‚Äì –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
        ‚Äì –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞
        ‚Äì –≤–≤–æ–¥ –¥–µ—Ç–∞–ª–µ–π
        ‚Äì –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è
        """

        w = context.user_data.get('waiting')

        # 1. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞

        if w == 'text_mode':
            if text == "üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
                context.user_data.clear()
                from .handlers_nco import get_main_keyboard
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏!",
                    reply_markup=get_main_keyboard(True), **kw
                )
                return True

            if text == "üí¨ –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç":
                context.user_data.update({'text_mode': 'free', 'waiting': 'text_prompt'})
                await update.message.reply_text(
                    "‚ú® –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ –∏–¥–µ—é –ø–æ—Å—Ç–∞ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.\n\n"
                    "üí° *–ü—Ä–∏–º–µ—Ä:* ¬´–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –Ω–∞—à –ø—Ä–∏—é—Ç –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏ –∫–∞–∫ –ª—é–¥–∏ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å¬ª\n\n"
                    "–ß–µ–º –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π ‚Äî —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—Å—è –ø–æ—Å—Ç!",
                    reply_markup=BACK_SIMPLE,
                    parse_mode='Markdown',
                    **kw
                )
                return True

            if text == "üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞":
                context.user_data.update({'text_mode': 'structured', 'waiting': 'select_post_type'})
                await update.message.reply_text(
                    "üìù –í—ã–±–µ—Ä–∏ —Ç–∏–ø –ø–æ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å:",
                    reply_markup=post_type_kb,
                    **kw
                )
                return True

        # 2. –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞
        
        if w == 'select_post_type':
            if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
                context.user_data['waiting'] = 'text_mode'
                await update.message.reply_text(
                    "üëå –•–æ—Ä–æ—à–æ, –≤–µ—Ä–Ω—ë–º—Å—è –∫ –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞.", reply_markup=text_mode_kb, **kw
                )
                return True

            # –¢–∏–ø –≤—ã–±—Ä–∞–Ω ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–µ—Ç–∞–ª—è–º
            context.user_data['post_type'] = text
            context.user_data['waiting'] = 'text_prompt'
            await update.message.reply_text(
                f"‚úÖ –¢–∏–ø: *{text}*\n\n"
                "–¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø–æ—Å—Ç–µ!\n\n"
                "üí° *–ß—Ç–æ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å:*\n"
                "‚Äî –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –∞–∫—Ü–∏—è\n"
                "‚Äî –∫–æ–≥–¥–∞ –∏ –≥–¥–µ –æ–Ω–æ –ø—Ä–æ–π–¥—ë—Ç\n"
                "‚Äî –∫–æ–≥–æ –≤—ã –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç–µ\n"
                "‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
                "‚Äî –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏\n\n"
                "–ß–µ–º
